<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>✨ 萌萌表情工坊</title>

    <!-- 核心库 -->
    <script src="./libs/tailwindcss.js"></script>
    <script src="./libs/lucide.min.js"></script>
    <script src="./libs/alpine.min.js" defer></script>

    <!-- 在线兜底 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>

    <link
        href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+SC:wght@400;700&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                        cute: ['"Fredoka"', 'sans-serif'],
                    },
                    colors: {
                        brand: { pink: '#FFB7B2', blue: '#A2E1DB', yellow: '#FFDAC1', purple: '#E2F0CB', dark: '#4A4A4A' }
                    },
                    animation: { 'wiggle': 'wiggle 1s ease-in-out infinite' },
                    keyframes: { wiggle: { '0%, 100%': { transform: 'rotate(-3deg)' }, '50%': { transform: 'rotate(3deg)' } } }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #FFF5F5;
            background-image: radial-gradient(#FFE4E1 1px, transparent 1px);
            background-size: 20px 20px;
            -webkit-tap-highlight-color: transparent;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 3px solid #FFF;
            box-shadow: 0 8px 20px -5px rgba(255, 183, 178, 0.3);
        }

        .btn-cute {
            transition: all 0.1s;
            box-shadow: 0 4px 0 rgba(0, 0, 0, 0.1);
        }

        .btn-cute:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .bg-checkerboard {
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%), linear-gradient(-45deg, #eee 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #eee 75%), linear-gradient(-45deg, transparent 75%, #eee 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        /* 输入框样式去除默认箭头 */
        input[type=number] {
            -moz-appearance: textfield;
        }

        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body class="text-brand-dark min-h-screen pb-24" x-data="app()" x-init="initApp()">

    <!-- 顶部通知 -->
    <div class="fixed top-4 left-1/2 -translate-x-1/2 z-[70] w-max max-w-[90%] transition-all duration-300 pointer-events-none"
        x-show="toast.show" x-transition:enter="transform ease-out duration-300 transition-translate-y"
        x-transition:enter-start="-translate-y-10 opacity-0" x-transition:enter-end="translate-y-0 opacity-100"
        x-transition:leave="transform ease-in duration-200" x-transition:leave-start="translate-y-0 opacity-100"
        x-transition:leave-end="-translate-y-10 opacity-0" x-cloak>
        <div
            class="bg-gray-800/90 backdrop-blur text-white px-4 py-2 rounded-full shadow-xl flex items-center gap-2 text-sm font-bold border border-white/20">
            <i data-lucide="sparkles" class="w-4 h-4 text-yellow-300"></i>
            <span x-text="toast.message"></span>
        </div>
    </div>

    <!-- 顶部导航 -->
    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b-2 border-brand-pink/30 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between gap-2 sm:gap-4">
            <div class="flex items-center gap-2 select-none flex-shrink-0 cursor-pointer" @click="switchMode('prompt')">
                <div
                    class="w-9 h-9 bg-gradient-to-br from-brand-pink to-brand-yellow rounded-xl flex items-center justify-center text-white shadow-md transform -rotate-3">
                    <i data-lucide="smile-plus" class="w-5 h-5"></i>
                </div>
                <h1 class="font-cute text-lg sm:text-xl font-bold text-gray-800 truncate">萌萌工坊</h1>
            </div>

            <div class="flex-1 overflow-x-auto no-scrollbar flex justify-end mask-linear">
                <div class="flex bg-gray-100/80 p-1 rounded-full gap-2 flex-nowrap">
                    <button @click="switchMode('prompt')"
                        :class="mode === 'prompt' ? 'bg-white text-brand-pink shadow-sm' : 'text-gray-400'"
                        class="px-3 py-1.5 rounded-full font-bold transition-all text-xs sm:text-sm flex items-center gap-1.5 whitespace-nowrap flex-shrink-0">
                        <i data-lucide="wand-2" class="w-3.5 h-3.5"></i> 咒语
                    </button>
                    <button @click="switchMode('cutter')"
                        :class="mode === 'cutter' ? 'bg-white text-brand-blue shadow-sm' : 'text-gray-400'"
                        class="px-3 py-1.5 rounded-full font-bold transition-all text-xs sm:text-sm flex items-center gap-1.5 whitespace-nowrap flex-shrink-0">
                        <i data-lucide="scissors" class="w-3.5 h-3.5"></i> 切图
                    </button>
                    <button @click="switchMode('animator')"
                        :class="mode === 'animator' ? 'bg-white text-brand-purple shadow-sm !text-green-600' : 'text-gray-400'"
                        class="px-3 py-1.5 rounded-full font-bold transition-all text-xs sm:text-sm flex items-center gap-1.5 whitespace-nowrap flex-shrink-0">
                        <i data-lucide="film" class="w-3.5 h-3.5"></i> 动图
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-3 sm:px-4 py-6">

        <!-- ==================== 模式 1: 咒语生成 (固定 4x6) ==================== -->
        <div x-show="mode === 'prompt'" x-transition.opacity.duration.300ms>
            <div class="text-center mb-8">
                <h2 class="text-2xl font-cute font-bold text-gray-700 mb-2">Step 1. 获取灵感</h2>
                <p class="text-sm text-gray-500 px-4">复制固定咒语，去 Nano Banana Pro 生成 <b>16:9 (4K)</b> 图片</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 静态组图 -->
                <div class="glass-panel rounded-3xl p-5 relative group hover:border-brand-blue transition-colors">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div
                                class="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center text-brand-blue font-bold text-xs">
                                1</div>
                            <h3 class="font-bold text-gray-700 text-sm">静态表情包 Prompt</h3>
                        </div>
                        <button @click="copyText(prompts.grid)"
                            class="btn-cute px-3 py-1.5 bg-brand-blue text-white rounded-full shadow-md flex items-center gap-1 text-xs">
                            <i data-lucide="copy" class="w-3 h-3"></i> 复制
                        </button>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-3 text-xs text-gray-600 font-mono leading-relaxed h-40 overflow-y-auto border-2 border-transparent group-hover:border-blue-100 transition-colors select-all whitespace-pre-wrap"
                        x-text="prompts.grid"></div>
                </div>

                <!-- 动图序列 -->
                <div class="glass-panel rounded-3xl p-5 relative group hover:border-brand-purple transition-colors">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-2">
                            <div
                                class="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center text-brand-purple font-bold text-xs text-green-600">
                                2</div>
                            <h3 class="font-bold text-gray-700 text-sm">动图序列帧 Prompt</h3>
                        </div>
                        <button @click="copyText(prompts.single)"
                            class="btn-cute px-3 py-1.5 bg-brand-purple text-green-700 rounded-full shadow-md flex items-center gap-1 text-xs">
                            <i data-lucide="copy" class="w-3 h-3"></i> 复制
                        </button>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-3 text-xs text-gray-600 font-mono leading-relaxed h-40 overflow-y-auto border-2 border-transparent group-hover:border-purple-100 transition-colors select-all whitespace-pre-wrap"
                        x-text="prompts.single"></div>
                </div>
            </div>

            <div class="mt-10 text-center">
                <button @click="switchMode('cutter')"
                    class="btn-cute px-8 py-3 bg-gray-800 text-white rounded-full font-bold shadow-xl inline-flex items-center gap-2 text-sm">
                    <span>去切图</span> <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- ==================== 模式 2: 智能切图 (左右布局优化) ==================== -->
        <div x-show="mode === 'cutter'" x-transition.opacity.duration.300ms x-cloak>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1 space-y-4">
                    <div class="glass-panel rounded-3xl p-5">
                        <h2 class="font-cute text-lg font-bold text-gray-700 mb-4 flex items-center gap-2">
                            <i data-lucide="scissors" class="w-5 h-5 text-brand-blue"></i> 静态切图
                        </h2>

                        <!-- 紧凑布局：左图(宽) 右参数(窄) -->
                        <div class="flex gap-3 h-32">
                            <!-- 上传区 (拉宽) -->
                            <label
                                class="flex-1 cursor-pointer group relative overflow-hidden rounded-2xl border-4 border-dashed border-brand-blue/30 bg-blue-50/50 hover:bg-blue-50 transition-all flex flex-col items-center justify-center h-full">
                                <template x-if="!cutter.uploadedImage">
                                    <div class="text-center p-1">
                                        <i data-lucide="upload-cloud"
                                            class="w-6 h-6 mx-auto text-brand-blue/60 mb-1"></i>
                                        <span
                                            class="font-bold text-[10px] text-gray-500 block leading-tight">上传<br>大图</span>
                                    </div>
                                </template>
                                <template x-if="cutter.uploadedImage">
                                    <img :src="cutter.uploadedImage"
                                        class="w-full h-full object-cover opacity-50 blur-[1px]">
                                </template>
                                <div x-show="cutter.uploadedImage"
                                    class="absolute inset-0 flex items-center justify-center">
                                    <span
                                        class="bg-white/80 text-brand-blue px-2 py-1 rounded text-[10px] font-bold shadow-sm backdrop-blur">更换</span>
                                </div>
                                <input type="file" accept="image/*" class="hidden" @change="handleCutterUpload">
                            </label>

                            <!-- 参数设置区 (更窄，只够放数字) -->
                            <div class="w-20 flex flex-col justify-between flex-shrink-0">
                                <div>
                                    <label
                                        class="text-[10px] font-bold text-gray-400 uppercase block mb-0.5 text-center">列数</label>
                                    <input type="number" x-model="cutter.cols"
                                        @input="if(cutter.rawImage) processSlices()"
                                        class="w-full px-1 py-2 rounded-lg bg-gray-50 border border-gray-200 font-bold text-sm text-center focus:ring-1 ring-brand-blue outline-none">
                                </div>
                                <div>
                                    <label
                                        class="text-[10px] font-bold text-gray-400 uppercase block mb-0.5 text-center">行数</label>
                                    <input type="number" x-model="cutter.rows"
                                        @input="if(cutter.rawImage) processSlices()"
                                        class="w-full px-1 py-2 rounded-lg bg-gray-50 border border-gray-200 font-bold text-sm text-center focus:ring-1 ring-brand-blue outline-none">
                                </div>
                            </div>
                        </div>

                        <div x-show="cutter.slices.length > 0" class="mt-4 animate-wiggle">
                            <button @click="downloadAllSlices"
                                class="btn-cute w-full py-3 rounded-xl bg-brand-blue text-white font-bold shadow-lg shadow-blue-100 flex items-center justify-center gap-2 text-sm">
                                <i data-lucide="package" class="w-4 h-4"></i> 打包下载 (ZIP)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 预览 -->
                <div class="lg:col-span-2">
                    <div class="glass-panel rounded-3xl p-4 h-full min-h-[400px] flex flex-col">
                        <div class="flex justify-between items-center mb-4 px-2">
                            <h2 class="font-cute text-lg font-bold text-gray-700">预览结果</h2>
                            <span class="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded-full"
                                x-text="cutter.cols + 'x' + cutter.rows + ' 智能居中'"></span>
                        </div>

                        <div x-show="!cutter.uploadedImage"
                            class="flex-1 flex flex-col items-center justify-center text-gray-300 border-4 border-dashed border-gray-100 rounded-2xl bg-white/30">
                            <i data-lucide="layout-grid" class="w-16 h-16 mb-2 opacity-20"></i>
                            <p class="text-xs">请上传生成的网格图</p>
                        </div>

                        <div x-show="cutter.uploadedImage"
                            class="grid gap-2 overflow-y-auto max-h-[500px] p-1 custom-scrollbar"
                            :style="`grid-template-columns: repeat(${cutter.cols}, minmax(0, 1fr));`">
                            <template x-for="(slice, index) in cutter.slices" :key="index">
                                <div class="group relative bg-white rounded-lg shadow-sm border border-gray-100 aspect-square flex items-center justify-center overflow-hidden bg-checkerboard cursor-pointer"
                                    @click="sendToAnimator(slice)">
                                    <img :src="slice" class="w-full h-full object-contain">
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== 模式 3: 动图制作 (左右布局优化) ==================== -->
        <div x-show="mode === 'animator'" x-transition.opacity.duration.300ms x-cloak>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="glass-panel rounded-3xl p-6 shadow-xl relative overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-cute text-xl font-bold text-gray-700 flex items-center gap-2">
                            <i data-lucide="film" class="w-5 h-5 text-brand-purple"></i> 动图制作
                        </h2>
                    </div>

                    <!-- 布局优化：左图(宽) 右参数(窄) -->
                    <div class="flex gap-3 mb-4 h-32">
                        <!-- 上传区 -->
                        <label
                            class="flex-1 cursor-pointer group relative overflow-hidden rounded-2xl border-4 border-dashed border-brand-purple bg-white hover:bg-purple-50 transition-all flex flex-col items-center justify-center h-full"
                            :class="{'border-solid border-brand-pink': animator.imageSrc}">
                            <template x-if="!animator.imageSrc">
                                <div class="text-center p-1">
                                    <i data-lucide="upload" class="w-6 h-6 mx-auto text-brand-purple/60 mb-1"></i>
                                    <span
                                        class="font-bold text-[10px] text-gray-500 block leading-tight">上传<br>序列图</span>
                                </div>
                            </template>
                            <template x-if="animator.imageSrc">
                                <img :src="animator.imageSrc" class="w-full h-full object-contain p-2">
                            </template>
                            <div x-show="animator.imageSrc"
                                class="absolute inset-0 flex items-center justify-center bg-black/0 hover:bg-black/10 transition-colors">
                                <span
                                    class="opacity-0 hover:opacity-100 bg-black/60 text-white text-xs px-2 py-1 rounded">更换</span>
                            </div>
                            <input type="file" accept="image/*" class="hidden" @change="handleAnimatorUpload">
                        </label>

                        <!-- 参数区 (窄) -->
                        <div class="w-20 flex flex-col justify-between flex-shrink-0">
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 block mb-0.5 text-center">列数</label>
                                <input type="number" x-model="animator.cols"
                                    class="w-full px-1 py-2 rounded-lg bg-gray-50 border border-purple-200 text-center font-bold text-sm focus:ring-1 ring-brand-purple outline-none">
                            </div>
                            <div>
                                <label class="text-[10px] font-bold text-gray-400 block mb-0.5 text-center">行数</label>
                                <input type="number" x-model="animator.rows"
                                    class="w-full px-1 py-2 rounded-lg bg-gray-50 border border-purple-200 text-center font-bold text-sm focus:ring-1 ring-brand-purple outline-none">
                            </div>
                        </div>
                    </div>

                    <!-- 速度控制 -->
                    <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 mb-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-[10px] font-bold text-gray-500">FPS (速度)</span>
                            <span class="text-[10px] font-mono text-brand-purple" x-text="animator.fps"></span>
                        </div>
                        <input type="range" min="1" max="24" x-model="animator.fps"
                            class="w-full h-1.5 bg-gray-200 rounded-full accent-brand-purple">
                    </div>

                    <button @click="generateGif" :disabled="!animator.imageSrc || animator.isGenerating"
                        class="btn-cute w-full py-3 rounded-xl bg-brand-dark text-white font-bold shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <i x-show="!animator.isGenerating" data-lucide="play-circle" class="w-4 h-4"></i>
                        <i x-show="animator.isGenerating" data-lucide="loader" class="w-4 h-4 animate-spin"></i>
                        <span x-text="animator.isGenerating ? '合成中...' : '生成 GIF'"></span>
                    </button>
                </div>

                <div
                    class="glass-panel rounded-3xl p-6 flex flex-col items-center justify-center min-h-[300px] relative bg-white">
                    <div
                        class="absolute top-0 left-0 w-full h-full opacity-10 pointer-events-none bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMiIgY3k9IjIiIHI9IjEiIGZpbGw9IiM5QzlDOUMiLz48L3N2Zz4=')]">
                    </div>
                    <h3 class="absolute top-6 left-6 font-bold text-gray-400 text-sm">GIF 预览</h3>

                    <div x-show="!animator.resultGif && !animator.isGenerating" class="text-center text-gray-300">
                        <i data-lucide="film" class="w-12 h-12 mx-auto mb-2 opacity-30"></i>
                        <p class="text-xs">等待生成...</p>
                    </div>

                    <div x-show="animator.isGenerating" class="text-center z-10">
                        <div
                            class="w-10 h-10 border-4 border-brand-purple border-t-transparent rounded-full animate-spin mx-auto mb-2">
                        </div>
                        <p class="text-xs text-gray-400">序列帧合成中...</p>
                    </div>

                    <div x-show="animator.resultGif" class="text-center w-full animate-wiggle-enter z-10">
                        <img :src="animator.resultGif"
                            class="w-48 h-48 object-contain mx-auto drop-shadow-xl bg-checkerboard rounded-lg border-4 border-white">
                        <div class="mt-6">
                            <a :href="animator.resultGif" download="animated_emoji.gif"
                                class="btn-cute inline-flex items-center gap-2 px-6 py-2 bg-green-500 text-white rounded-full font-bold shadow-lg shadow-green-200 text-sm">
                                <i data-lucide="download" class="w-4 h-4"></i> 保存 GIF
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center mt-12 text-gray-400 text-xs font-sans pb-8">
        <p>© 2025 MeMaker. Local processing only.</p>
    </footer>

    <script>
        function app() {
            return {
                mode: 'prompt',
                toast: { show: false, message: '' },

                prompts: {
                    grid: `为我生成图中人物的绘制 Q 版的，彩色手绘 LINE 风格的半身像表情包，注意头饰、衣服要正确；涵盖各种各样的常用聊天语句，或是一些有关的娱乐 meme；每个表情配上可爱中文字体；纯白背景，4x6布局，不要画出网格线`,
                    single: `为我生成图中人物的绘制 Q 版的，彩色手绘 LINE 风格的半身像表情包，注意头饰要正确；4x6布局，小图片分别为“飞吻”动画的连贯的拆分动作，使用这24张可以组成一个完整的、循环动画，动作流畅逼真，最后一帧应流畅地循环回到第一帧。24张图片里都使用可爱的字体写着汉字“爱你”。纯白背景，不要画出网格线`
                },

                cutter: {
                    uploadedImage: null,
                    rawImage: null,
                    slices: [],
                    isProcessing: false,
                    cols: 6, // 默认预设
                    rows: 4
                },

                animator: {
                    imageSrc: null,
                    rawImage: null,
                    resultGif: null,
                    isGenerating: false,
                    fps: 12,
                    cols: 6, // 默认预设
                    rows: 4,
                    workerBlobUrl: null
                },

                async initApp() {
                    try {
                        const resp = await fetch('https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js');
                        const txt = await resp.text();
                        const blob = new Blob([txt], { type: 'application/javascript' });
                        this.animator.workerBlobUrl = URL.createObjectURL(blob);
                    } catch (e) { }
                    this.$nextTick(() => lucide.createIcons());
                },

                switchMode(m) {
                    this.mode = m;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    this.$nextTick(() => lucide.createIcons());
                },

                showToast(msg) {
                    this.toast.message = msg;
                    this.toast.show = true;
                    setTimeout(() => { this.toast.show = false }, 2000);
                },

                copyText(text) {
                    const ta = document.createElement('textarea');
                    ta.value = text;
                    ta.style.position = 'fixed';
                    ta.style.left = '-9999px';
                    document.body.appendChild(ta);
                    ta.select();
                    try {
                        document.execCommand('copy');
                        this.showToast("复制成功！");
                    } catch (err) {
                        this.showToast("复制失败");
                    }
                    document.body.removeChild(ta);
                },

                // --- 切图逻辑 ---
                handleCutterUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        this.cutter.uploadedImage = evt.target.result;
                        const img = new Image();
                        img.onload = () => {
                            this.cutter.rawImage = img;
                            this.processSlices();
                        };
                        img.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                },

                // === 核心算法：参数化居中切分 ===
                processSlices() {
                    if (!this.cutter.rawImage) return;
                    this.cutter.isProcessing = true;

                    const img = this.cutter.rawImage;
                    const cols = parseInt(this.cutter.cols) || 6;
                    const rows = parseInt(this.cutter.rows) || 4;

                    const cellW = img.width / cols;
                    const cellH = img.height / rows;

                    // 智能居中裁剪
                    const cropSize = Math.min(cellW, cellH);
                    const cropX = (cellW - cropSize) / 2;
                    const cropY = (cellH - cropSize) / 2;

                    const tempSlices = [];
                    const sliceCanvas = document.createElement('canvas');
                    sliceCanvas.width = cropSize;
                    sliceCanvas.height = cropSize;
                    const sCtx = sliceCanvas.getContext('2d');

                    // 3. 循环切分
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            sCtx.clearRect(0, 0, cropSize, cropSize);
                            sCtx.drawImage(
                                img,
                                c * cellW + cropX,
                                r * cellH + cropY,
                                cropSize, cropSize,
                                0, 0, cropSize, cropSize
                            );
                            tempSlices.push(sliceCanvas.toDataURL('image/png'));
                        }
                    }
                    this.cutter.slices = tempSlices;
                    this.cutter.isProcessing = false;
                },

                downloadSingleSlice(dataUrl, index) {
                    const link = document.createElement('a');
                    link.href = dataUrl;
                    link.download = `emoji_${index + 1}.png`;
                    link.click();
                },

                async downloadAllSlices() {
                    const zip = new JSZip();
                    const folder = zip.folder("emojis");
                    this.cutter.slices.forEach((d, i) => {
                        folder.file(`emoji_${i + 1}.png`, d.split(',')[1], { base64: true });
                    });
                    const content = await zip.generateAsync({ type: "blob" });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(content);
                    link.download = "emoji_pack.zip";
                    link.click();
                },

                handleAnimatorUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        this.animator.imageSrc = evt.target.result;
                        this.animator.resultGif = null;
                        const img = new Image();
                        img.onload = () => { this.animator.rawImage = img; };
                        img.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                },

                async generateGif() {
                    if (!this.animator.rawImage || !this.animator.workerBlobUrl) return;
                    this.animator.isGenerating = true;

                    const size = 300;
                    const canvas = document.createElement('canvas');
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');

                    const gif = new GIF({
                        workers: 4,
                        quality: 10,
                        width: size,
                        height: size,
                        workerScript: this.animator.workerBlobUrl,
                        transparent: 0x00000000
                    });

                    // ---- 序列帧合成 (动态读取 cols/rows) ----
                    const img = this.animator.rawImage;
                    const cols = parseInt(this.animator.cols) || 6;
                    const rows = parseInt(this.animator.rows) || 4;
                    const totalFrames = cols * rows;

                    const cellW = img.width / cols;
                    const cellH = img.height / rows;
                    const cropSize = Math.min(cellW, cellH);
                    const cropX = (cellW - cropSize) / 2;
                    const cropY = (cellH - cropSize) / 2;

                    let frameIndex = 0;
                    for (let r = 0; r < rows; r++) {
                        for (let c = 0; c < cols; c++) {
                            if (frameIndex >= totalFrames) break;
                            ctx.clearRect(0, 0, size, size);
                            // 居中裁剪后绘制
                            ctx.drawImage(
                                img,
                                (c * cellW) + cropX, (r * cellH) + cropY, cropSize, cropSize,
                                0, 0, size, size
                            );
                            gif.addFrame(ctx, { copy: true, delay: 1000 / this.animator.fps });
                            frameIndex++;
                        }
                    }

                    gif.on('finished', blob => {
                        this.animator.resultGif = URL.createObjectURL(blob);
                        this.animator.isGenerating = false;
                    });
                    gif.render();
                }
            }
        }
    </script>
</body>

</html>